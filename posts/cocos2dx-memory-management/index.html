<!doctype html>
<html class="no-js" lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.78.1" />

  <title> cocos2d-x 메모리 관리에 대한 간단한 정리 &middot; /usr/lib/libsora.so </title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="naver-site-verification" content="2ddc1a56777489f4a64a4f6a59822f8b1c1ea502"/>
  <meta name="google-site-verification" content="VsvNNnJZUV-iLEYKNju16p-HtDqZeqL15H-VVy-HwpA" />

  <meta name="gc:client-id" content="785d47c81cbc2fd42b65">
  <meta name="gc:client-secret" content="5e5d558f0b16fae154aa47fc9d94f7c09e540ec7">

  
  <meta name="author" content="if1live" />
  

  
  <meta name="description" content="cocos2d-x 메모리 관리에 대한 간단한 정리" />
  

  
  <meta name="keywords" content="cpp, cocos2dx" />
  

  
  
<meta name="twitter:card" content="summary">
<meta name="og:url" content="https://libsora.so/posts/cocos2dx-memory-management/">

<meta name="twitter:site" content="@if1live">


<meta name="twitter:title" content="cocos2d-x 메모리 관리에 대한 간단한 정리">
<meta name="twitter:description" content="cocos2d-x는 cocos2d를 거의 그대로 포팅한 2d게임 엔진이다. 원작이 objc 기반인 cocos2d를 C&#43;&#43;로 옮겼으니 완전히 똑같지는 않다. 특히 메모리 모델의 경우는 언어상의 차이로 다를수밖에 없다.
objc의 메모리 관리는 기본적으로 레퍼런스 카운팅 방식이다. 모든 objc의 클래스는 NSObject를 상속받는다. retain, relea">

<meta name="twitter:image:src" content="https://www.gravatar.com/avatar/fb9672e7e0d256f39369595381d1ea07">



  

  
  
  <link rel="stylesheet" href="https://libsora.so/css/style-gen.css?2">

  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

  
  <link href="https://libsora.so/index.xml" rel="alternate" type="application/rss+xml" title="/usr/lib/libsora.so" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=="
  crossorigin="anonymous" />
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/plugins/line-numbers/prism-line-numbers.min.css"
  integrity="sha512-cbQXwDFK7lj2Fqfkuxbo5iD1dSbLlJGXGpfTDqbggqjHJeyzx88I3rfwjS38WJag/ihH7lzuGlGHpDBymLirZQ=="
  crossorigin="anonymous" />

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css"
  integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw=="
  crossorigin="anonymous" />


  
  <script type="text/javascript">
    var host = "libsora.so";
    if ((host == window.location.host) && (window.location.protocol != "https:")) {
      window.location.protocol = "https";
    } else {
      console.log("skip https redirect");
    }
  </script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: "ca-pub-3043297488880636",
  enable_page_level_ads: true
});
</script>

</head>
<body>

<header class="header">
  <h1 class="font-monospace">
    <a href="https://libsora.so/">/usr/lib/libsora.so</a>
  </h1>
  <nav>
    <h2 hidden>Navigation</h2>
    <ul class="nav-link-list">
      <li>
        <a href="https://libsora.so/about/"  title="about">
          <i class="fa fa-info"><span hidden>about</span></i>
        </a>
      </li>
      <li>
        <a href="https://libsora.so/projects/"  title="projects">
          <i class="fa fa-code"><span hidden>projects</span></i>
        </a>
      </li>
      <li>
        <a href="https://libsora.so/archives/"  title="archives">
          <i class="fa fa-archive"><span hidden>Archives</span></i>
        </a>
      </li>
      <li>
        <a href="https://libsora.so/tags/"  title="tags">
          <i class="fa fa-tags"><span hidden>Tags</span></i>
        </a>
      </li>
      <li>
        <a href="https://libsora.so/search/"  title="search">
          <i class="fa fa-search"><span hidden>Search</span></i>
        </a>
      </li>
    </ul>
  </nav>
</header>


<div class="container">
  <article class="basic-content article-content">
    <header>
      <hgroup class="entry-title">
        <a href="/posts/cocos2dx-memory-management/" rel="bookmark" title="Permalink to cocos2d-x 메모리 관리에 대한 간단한 정리">
          <h1>cocos2d-x 메모리 관리에 대한 간단한 정리</h1>
          
        </a>
      </hgroup>
    </header>

    <footer class="post-info">
      <abbr class="published" title='2013-01-25T00:00:00Z'>
        2013/01/25
      </abbr>
      
      <address class="vcard author">
        By <a href="//twitter.com/if1live">@if1live</a>
      </address>
      

      <ul class="list-of-tags tags-in-article">
        
        <li>
          <a href="/tags/cpp">#cpp</a>
        </li>
        
        <li>
          <a href="/tags/cocos2dx">#cocos2dx</a>
        </li>
        
      </ul>
    </footer>

    <section class="entry-content">
      <p>cocos2d-x는 cocos2d를 거의 그대로 포팅한 2d게임 엔진이다.
원작이 objc 기반인 cocos2d를 C++로 옮겼으니 완전히 똑같지는 않다.
특히 메모리 모델의 경우는 언어상의 차이로 다를수밖에 없다.</p>
<p>objc의 메모리 관리는 기본적으로 레퍼런스 카운팅 방식이다. 모든 objc의 클래스는 NSObject를 상속받는다.
retain, release를 적절히 써서 레러런서 카운팅 쌍을 맞춰주면 적절히 메모리가 관리된다.
autorelease를 사용하면 NSAutoreleasePool에 생성된 객체가 등록된다.
이후 NSAutoreleasePool이 해제되면 풀에 등록된 모든 객체에 대해서 release를 수행한다.</p>
<p>하지만 C++에는 기본적으로는 저런기능이 존재하지 않는다. new로 객체를 생성하고 delete로 객체를 해제한다.
autorelase? 그딴건 니가 만들어야함ㅋ
(물론 이제는 표준이된 std::shared_ptr,
일부컴파일러에서는 std::tr1::shared_ptr라는 이름으로 레퍼런스 카운팅이 되긴 한다.
cocos2dx는 그런거 없이 자체 구현되어있으니까 일단 신경쓰지 않는다)</p>
<p>하지만 cocos2dx는 cocos2d를 거의 비슷하게 베끼려보니까 cocos2dx를 보면 CCObject라는 클래스로 objc에 있는 메모리 모델을 비슷하게 만들어놧다.</p>
<pre><code class="language-cpp">CCObject::CCObject(void)
{
    static unsigned int uObjectCount = 0;

    m_uID = ++uObjectCount;
    m_nLuaID = 0;

    // when the object is created, the refrence count of it is 1
    m_uReference = 1;		// &lt;--- CCObject를 상속받은 클래스는 객체가 생성될때 카운터가 1
    m_bManaged = false;
}
CCObject::~CCObject(void)
{
    // if the object is managed, we should remove it
    // from pool manager
    if (m_bManaged)		//autorelease를 햇던 경우에 플래그 올라감
    {
        CCPoolManager::sharedPoolManager()-&gt;removeObject(this);	//풀에서 제거
    }
	//적절히 생략
}
void CCObject::release(void)
{
    CCAssert(m_uReference &gt; 0, &quot;reference count should greater than 0&quot;);
    --m_uReference;		//release는 레퍼런스 카운터 내리기

	//레퍼런스 카운터 0되면 클래스 자ㅋ폭ㅋ
	//그래서 release후에 delete를 수동으로 하면 망한다
    if (m_uReference == 0)	
    {
        delete this;
    }
}

void CCObject::retain(void)
{
    CCAssert(m_uReference &gt; 0, &quot;reference count should greater than 0&quot;);
    ++m_uReference;		//retain은 레퍼런스 카운터 올리기
}

CCObject* CCObject::autorelease(void)
{
	//autorelase를 하는 경우, 적절히 autorlease pool에 등록하고 플래그를 올린다
    CCPoolManager::sharedPoolManager()-&gt;addObject(this);
    m_bManaged = true;
    return this;
}
</code></pre>
<p>위와 같이 CCObject를 구현해서 objc의 retain,release,autorelase와 동일한 API를 유지할수 있도록 되어잇다.
다음으로 진짜 cocos2dx 사용 예제 소스에서 어떻게 메모리가 돌아가나 보자</p>
<p>수동으로 레퍼런스 카운팅을 하도록 짜면 다음과 같다. 레퍼런스 카운팅의 변화는 주석으로 달아놧다</p>
<pre><code class="language-cpp">bool SimpleLayer::init() {
	if(!CCLayer::init()) {
		return false;
	}
	CCSprite *sprite = new CCSprite();	//ref : 1
	sprite-&gt;initWithFile(&quot;asdf.png&quot;);	//레퍼런스 변화없음
	this-&gt;addChild(sprite);		//CCArray같은 cocoa의 자료구조를 베낀것에 집어넣으면 1증가. ref : 2
	sprite-&gt;release();	//수동으로 내려서 ref : 1
	//이후 이 레이어가 해제될때
	//children으로 등록되어잇는 sprite에 대해서 release가 적절히 수행되서 ref : 0, 누수없이 객체 삭제
	return true;
}
</code></pre>
<p>위의 코드는 평범한 objc코드를 c++로 바로 변환한거니까 별로 중요하지 않다.
autorelease를 쓰는 예제는 다음과 같다. C++에는 원래 존재하지 않던 autoreleae를 적절히 만들어낸
cocos2dx의 신묘한 메모리 관리정책을 볼수잇다</p>
<pre><code class="language-cpp">bool SimpleLayer::init() {
	if(!CCLayer::init()) {
		return false;
	}
	CCSprite *sprite = CCSprite::spriteWithFile(&quot;asdf.png&quot;);	//ref:1, autorelease pool에 등록
	this-&gt;addChild(sprite);	//children등록되면서 +1, ref:1
	//이후 이 레이어가 해제될때
	//children으로 등록되어잇는 sprite에 대해서 release가 적절히 수행되서 ref : 1
	//ANG? ref=1이 남앗다고? 이건 그렇다면 언제 해제되는거지?
	return true;
}
</code></pre>
<p>예제의 코드만을 보면 ref=1이 남아있고 autorelase pool에 등록되어있는 상태이다.
그렇다면 레이어가 소멸햇지만 sprite는 해제되지 않고 남아잇는 상태라니 이게 무슨소리인가?</p>
<p>는 게임내부 소스를 까보면 신묘한 구현을 볼수있다.</p>
<pre><code class="language-cpp">void CCDisplayLinkDirector::mainLoop(void)
{
    if (m_bPurgeDirecotorInNextLoop)
    {
        m_bPurgeDirecotorInNextLoop = false;
        purgeDirector();
    }
    else if (! m_bInvalid)
     {
         drawScene();
     
         // release the objects
         CCPoolManager::sharedPoolManager()-&gt;pop();     //&lt;--- 
     }
}
</code></pre>
<pre><code class="language-cpp">void CCPoolManager::pop()
{
    if (! m_pCurReleasePool)
    {
        return;
    }
	int nCount = m_pReleasePoolStack-&gt;count();
    m_pCurReleasePool-&gt;clear();	//&lt;--
	.....
}
</code></pre>
<pre><code class="language-cpp">void CCAutoreleasePool::clear()
{
    if(m_pManagedObjectArray-&gt;count() &gt; 0)
    {
        CCObject* pObj = NULL;
        CCARRAY_FOREACH_REVERSE(m_pManagedObjectArray, pObj)
        {
            if(!pObj)
                break;

            pObj-&gt;m_bManaged = false;
            //(*it)-&gt;release();
            //delete (*it);
       }
        m_pManagedObjectArray-&gt;removeAllObjects();
    }
}
void CCAutoreleasePool::addObject(CCObject* pObject)
{
    m_pManagedObjectArray-&gt;addObject(pObject);
    CCAssert(pObject-&gt;m_uReference &gt; 1, &quot;reference count should be greater than 1&quot;);
    pObject-&gt;release(); // no ref count, in this case autorelease pool added.
}
</code></pre>
<p>CCDirector::mainLoop는 매 프레임마다 호출되는 함수이다. 이 함수 안에는 autorelease pool을 해제하는 함수를 호출한다.
CCPoolManager::pop을 거쳐서 CCAutoreleasePool::clear가 호출되서 공용 autorelease pool에 등록된 객체를 전부 해제한다.</p>
<p>autorelease pool을 clear하는 함수의 구현을 보면
모든 객체에 대해서
객체를 강제로 autorelease pool로 등록하지 않앗다고 플래그를 바꾸고
배열을 통째로 날린다. (배열을 비우면 배열안의 요소에 대해서 release가 호출된다)</p>
<p>autorelease pool에 객체를 등록하는 코드를 보면 레퍼런스 카운터를 원래상태로 유지하기 위해서 배열에 넣고 release를 수행한다</p>
<p>코드를 까봄으로써 알게된 추가사항을 다시 예제에 적용하면 다음과 같다</p>
<pre><code class="language-cpp">//객체 생성되서 ref=1
//autorelease pool에 등록해도 ref count는 변하지 않는다. ref=1
CCSprite *sprite = CCSprite::spriteWithFile(&quot;asdf.png&quot;);
this-&gt;addChild(sprite);	//children등록되면서 +1, ref:2
//이후 이 레이어가 해제될때
//children으로 등록되어잇는 sprite에 대해서 release가 적절히 수행되서 ref : 1

/*** 프레임 종료, mainLoop의 끝 ***/
//autorelase pool에 등록된 객체에 대해서 전부 relase를 호출해서 카운터 -1

//위에서 생성된 객체가 layer같은곳에 등록되어있어서 ref count=2인 상태이면 ref=1로 변함. 
//layer같은거에서 제거될때 레퍼런스 카운터가 1 줄어서 적절히 객체 해제됨

//autorelase로 객체를 생성하고 어디 등록하지 않고 냅둔경우(ref=1)
//autorelase가 적절히 release를 해제해서 카운터 1 줄어서 메모리 해제됨. 누수없음
</code></pre>
<p>좋은 메모리 관리 모델이다.
개발자는 initXXX을 써서 수동으로 관리하건 spriteXXX를 써서 자동으로 맡기건 어쨋든 잘 짜면 메모리 누수는 없다</p>
<p>하지만 이걸로 끝나지 않는다. 몇가지 문제점이 존재한다</p>
<ul>
<li>retain, release는 락이 존재하지 않는다. 멀티 쓰레드로 가면 아마 사고칠거다</li>
<li>autorelase pool을 중첩해서 사용할수없다
<ul>
<li>mainLoop에서 처리하는 autorelase pool은 공용 autorelase pool 하나뿐이다</li>
</ul>
</li>
</ul>
<p>물론 <a href="http://cocos2d-x.org/projects/cocos2d-x/wiki/Memory_Management_in_Cocos2d-x">위키</a>에도 언급된 사항이다.<br>
위의 개념과 엮여서 발생가능한 문제도 있는데 이는 위키를 적절히 참고하자.
(하지만 나는 영어가 딸려서 결국 코드를 까봣지&hellip;-_- 차라리 C++이 더 쉬워)</p>

    </section>

    <ul class="articles-timeline">
      <li class="previous-article">
        
        <a href="https://libsora.so/posts/class-init-with-memset/" title="Next: memset로 클래스 초기화 쉽게 하기">
          memset로 클래스 초기화 쉽게 하기
          
        </a>
        
      </li>

      <li class="next-article">
        
        <a href="https://libsora.so/posts/charp-like-property/" title="Previous: C#의 프로퍼티 C&#43;&#43;에서 쓰기">
          C#의 프로퍼티 C&#43;&#43;에서 쓰기
          
        </a>
        
      </li>
    </ul>

    <section class="entry-content">
      <section class="disqus-section">
<h1 hidden>Comment</h1>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var host = "libsora.so";
  if (host == window.location.host) {
    var disqus_shortname = 'libsora';
    var disqus_identifier = 'http://libsora.so\/posts\/cocos2dx-memory-management\/';

    (function() {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  } else {
    console.log("skip disqus");
  }
</script>
<noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

    </section>
  </article>
</div>

<footer class="footer">
  <ul class="nav-link-list">
    
    
    
    <li>
      
      <a href="//twitter.com/if1live" title="Twitter"><i class="fa fa-twitter"> </i></a>
    </li>
    
    
    
    <li>
      
      <a href="//github.com/if1live" title="GitHub"><i class="fa fa-github"> </i></a>
    </li>
    
    
    
    <li>
      
      <a href="//bitbucket.org/if1live" title="BitBucket"><i class="fa fa-bitbucket"> </i></a>
    </li>
    

    <li>
      
      <a href="https://libsora.so/index.xml"><i class="fa fa-rss"> </i></a>
    </li>

    
  </ul>

  <p>
    <a href="//gohugo.io/" title="Hugo">Hugo</a> |
    
    <a href="//twitter.com/if1live/" title="@if1live">@if1live</a>
    
  </p>
</footer>

<script src="/js/common.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/prism.min.js"
  integrity="sha512-9+422Bs3A87UkWfp+qV80Nfv9arhbCXKY1rxrF2seorI36mIIstMiuBfyKLF1yH1nnzQkEWq2xrzT4XU3Z+vrA=="
  crossorigin="anonymous"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/plugins/line-numbers/prism-line-numbers.min.js"
  integrity="sha512-1oLZvExT5RaW4q2GgvRPf+XzVVGmsKirfZBRN7aifdOpvZ1L9idEncfMFlfHiQNGBA+Sev+alscSAT/xQ0rwXA=="
  crossorigin="anonymous"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-clike.min.js"
  integrity="sha512-/WJ9ZNER39LEXW4XzFoMR6ct++/HT++A71MDW2gBbUJExj8hFRtde5Q5QzcHyBMxU97VeH1wEHGBRtNuGJpV4w=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-c.min.js"
  integrity="sha512-TO7UeOg1N67oP7UU2OzrOm0oZrTz2TXGNRtkf/x+d9Pt5O8cb5jeSRcryiXqW/Nd25VEc8Qqtu8Dx1EVV7AJLQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-cpp.min.js"
  integrity="sha512-dzF2RO45FHCMPdWDQ3I7Cn9xPvCM8x8T4ODz+kSPQl5CAuIMy6Ekb2i2DAjLEpG/V/DL9f/O7+9E/HZQQx89IA=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-typescript.min.js"
  integrity="sha512-5KnWNKu6jz8OE4nIBndz3PZ4O3RGqcPNcsyEFZkx3F5N8liSwc3bCe4qPOa/a3+e4CxVl0izHMXeZ0Z4yk7LTA=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-python.min.js"
  integrity="sha512-EXseTM1JV8e3AonU5PfOUmzbPkUTRm4c4hVxv206gVeWZE/FwzSQBNWrUBaHsN3Idq9k76BEjUlXpluX1UFx6Q=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-javascript.min.js"
  integrity="sha512-UN3RxBb1KfsWQUMNl19SU/JPer3v8jTBpfGyQaBEuaVjP5q0Gz9ihj8MiHEUZYnc1krYRm5imVebjq1egsSaKA=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-java.min.js"
  integrity="sha512-p2vAaPEsPvlIESCpoEI5IyzZowfdVZ2O39PsrOrkuTQl+AjD57T4L/Wxv5S8WCToLou0twQZaWO+tt660Rqb6Q=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-csharp.min.js"
  integrity="sha512-qvSIQfI/qEeMC1E1LMSPCsDl8vFzl0rkBfF6dDcnMJxQT+8M2WjSyDGqHQzZa+RChv3jkdKnZAo99BcAbGsnQg=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-bash.min.js"
  integrity="sha512-CILPDr/8BlkkElCeI+f2yMu0fzgwWqpQ0Cdr0busFfySJJ4SoCRivbT6+Z+SWPkjWwBil9NO0tHd6NSfpwiQaA=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-ruby.min.js"
  integrity="sha512-Wgi0cnFpl5EY8xLe1RO+uTsot86wzAbW/BIoqZopPU+8YW79VDqQE9qTe1R+1uhxLsPBHE+nYwACS+eTsE5GtQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-go.min.js"
  integrity="sha512-hVtwzUDz/n7RqQmiQ7xYAJCTTJe5C52Ung+4Kpz2fPRq7nq2h5gHHQe2HRy7f1Tj3OUVgTO5WRx7XuwT624C9Q=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-less.min.js"
  integrity="sha512-REVnwsprLWmQbtt0WjkS59nMvtKE0olIjUx+N/k3Gqa5WhmrZ7o0ahGhKYnIK6W2+ITg4cQ2UqZkka4RaZSM9Q=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-scss.min.js"
  integrity="sha512-rAb9BrnkhMpxN7NoOM7WwPa3phfCMMUZw568Tyzlj9frNsdUUeltfCTATD6ccnVLtnERR+ZXS85Ybs7wo9IiTQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-css.min.js"
  integrity="sha512-zDjwO/e5eVa5WfYra8CE827RFyA/nqhp8y4da+geEpAqpCnmfAHopCNobQ9sJeLBMQY0OLB+hT+k6bbb0FhdYQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-json.min.js"
  integrity="sha512-IC7rV8RslChgByOdUFC6ePqOGn+OwJhnKC3S5AezM8DAiOdGhJMwgsIvBChsa2yuxxoPbH2+W/kjNUM1cc+jUQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-yaml.min.js"
  integrity="sha512-j9sRnEoasdNn9OSwsCxjrQi1H55NqBFDJ+oe7me3sIfvDLeTyzvnZXf0eJqL5CvX6rswU2Sld9PnTVQ0Xy2CFQ=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-batch.min.js"
  integrity="sha512-YzSVmlznJS4QEi5/tSS9iZ/tVFGdQSKO/F2jsofNH+5PifywJfsOtOZaia+URhumCMdXTTG2UZQ4vtBHWids+Q=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/components/prism-lisp.min.js"
  integrity="sha512-3c6jwEnUKsrvucb8b9xdDJw13zOdbeP83PvlSKeoTCCWGacG03MUWHCcBev2NKHA+w8IAWZsGXBcNMaIH/VWYA=="
  crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.3/mermaid.min.js"
  integrity="sha512-+TNmhaRJf3jyYHTpzEq/5I6b+aGyhzWb21mGdHAjxSGSYwxN9Grug3Y3B9qVxWfKKY8MscE/6mr9walWvFLFvQ=="
  crossorigin="anonymous"></script>

<script>
  mermaid.initialize({ startOnLoad: true });

  (function () {
    const elems = document.querySelectorAll('code.language-mermaid');
    for (let i = 0; i < elems.length; i++) {
      const id = `mermaid-${i}`;
      const elem = elems[i];
      const source = elem.innerText;
      const cb = (svg) => {
        const div = document.createElement('div');
        div.innerHTML = svg;
        elem.parentElement.replaceWith(div);
      };
      mermaid.render(id, source, cb);
    }
  })();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js"
  integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg=="
  crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js"
  integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg=="
  crossorigin="anonymous"></script>

<script>
  renderMathInElement(document.body,
    {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    }
  );

  var inlineMathArray = document.querySelectorAll("script[type='math/tex']");
  for (var i = 0; i < inlineMathArray.length; i++) {
    var inlineMath = inlineMathArray[i];
    var tex = inlineMath.innerText || inlineMath.textContent;
    var replaced = document.createElement("span");
    replaced.innerHTML = katex.renderToString(tex, { displayMode: false });
    inlineMath.parentNode.replaceChild(replaced, inlineMath);
  }

  var displayMathArray = document.querySelectorAll("script[type='math/tex; mode=display']");
  for (var i = 0; i < displayMathArray.length; i++) {
    var displayMath = displayMathArray[i];
    var tex = displayMath.innerHTML;
    var replaced = document.createElement("span");
    replaced.innerHTML = katex.renderToString(tex.replace(/%.*/g, ''), { displayMode: true });
    displayMath.parentNode.replaceChild(replaced, displayMath);
  }
</script>


<script>
  var host = "libsora.so";
  if (host == window.location.host) {
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-37862172-2','auto');ga('send','pageview')
  } else {
    console.log("skip google analytics");
  }
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>

